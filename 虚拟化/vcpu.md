# vcpu

在学习qemu的时候，遇到了vcpu这个概念。

我一开始的理解是，vcpu是qemu用软件模拟的，模拟执行一条cpu的汇编指令

比如`mov eax,1`，这样一条指令的执行，

qemu给vcpu设置了一个vcpu的数组以模拟真实cpu的寄存器，然后将`eax`寄存器对应的值设置为1

但是这样的理念仔细想之后是非常错误的，因为要给vcpu的数组赋值这样一个操作，可能在c代码中就是简单的`vpu[EAX]=1`一行指令，但是由此在真实的cpu上执行会有非常多的指令，这样1条指令对应多条cpu指令，这样的开销显然是巨大的。

要想明白vcpu这样的概念，可以联想虚拟内存的设计

早期的计算机程序员编程的时候要直接跟物理内存和外存打交道，非常麻烦，虚拟存储解决了这个问题。每个进程都使用一个独立的、很大的存储空间，具体物理内存的分配和数据在内存和外存的调入调出都由操作系统自动完成。

虚拟存储技术“虚拟” 了内存，那么多线程和虚拟机技术则“虚拟” 了CPU

虚拟机技术则通过微结构的硬件增强，如设立多组控制寄存器和系统状态等，实现多个操作系统的快速切换，达到在同一台计算机上“同时” 运行多个操作系统的目的。

vcpu也是像虚拟内存一样将cpu的状态存储，然后再借助kvm使用ioctl技术，将虚拟的cpu映射到真实的cpu上面